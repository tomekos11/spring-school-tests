<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/head :: head"></head>

<body>
<div th:replace="fragments/navbar :: nav(user=${user})"></div>

<div class="container mt-5">

    <div class="card">
        <div class="card-header">
            <h2 th:text="${'Edycja testu Nr' + test.getId()}"></h2>
        </div>
        <div class="card-body">
            <h4 class="text-success" th:text="${message}"></h4>
            <form th:action="@{/api/tests/{testId}(testId=${test.getId()})}" th:object="${test}" id="edit-test-form">
                <div class="form-group">
                    <label for="name">Nazwa Testu</label>
                    <input type="text" class="form-control" id="name" name="name" th:value="${test.getName()}" placeholder="Wprowadź nazwę testu" required>
                </div>
                <div class="form-group">
                    <label for="alias">Alias Testu</label>
                    <input type="text" class="form-control" id="alias" name="alias" th:value="${test.getAlias()}" placeholder="Wprowadź alias testu" required>
                </div>
                <button class="btn btn-primary" onclick="changeTestDetails(event)">Zapisz zmiany</button>
            </form>
        </div>
    </div>

    <!-- Lista pytań -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>Lista pytań</h4>
        </div>
        <div class="card-body">
            <div class="accordion" id="questionsAccordion">
        </div>
    </div>

</div>

<script th:inline="javascript">

    var testData = [[${test}]];

    console.log(testData);
    console.log(testData.questions);

    for (var i = 0; i < testData.questions.length; i++) {
        var question = testData.questions[i];
        addQuestion(question, i);
    }

    function addQuestion(questionData, index) {
        var accordion = document.getElementById('questionsAccordion');

        // Create new question HTML
        var newQuestionHTML = `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading${index}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                        ${question.content}
                    </button>
                </h2>
                <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}" data-bs-parent="#questionsAccordion">
                    <div class="accordion-body">
                        <!-- Formularz dodawania odpowiedzi -->
                        <form th:action="@{/api/tests/{testId}/questions/{questionId}/answers(testId=${testData.id}, questionId=${question.id})}" method="post" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="question">Pytanie</label>
                                <input type="text" value="${question.content}" class="form-control" id="question" name="question" required>
                            </div>
                            <div class="form-group">
                                <label for="points">Liczba punktów</label>
                                <input type="number" value="${question.pointAmount}" class="form-control" id="points" name="points" min="0" required>
                            </div>
                            <div class="form-group mt-2">
                                <label for="image">Załącz zdjęcie</label>
                                <input type="file" class="form-control-file" id="image" name="image">
                            </div>
                            <div class="form-group mt-2">
                                <label>Odpowiedzi</label>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th class="text-center">Odpowiedź</th>
                                            <th class="text-center">Poprawność</th>
                                            <th class="text-center">Akcja</th>
                                        </tr>
                                    </thead>
                                    <tbody id="answersTable${index}">
                                        <!-- Placeholder row for no answers -->
                                        <tr id="noAnswersRow${index}" class="d-none">
                                            <td class="text-center" colspan="3">Brak dodanych do tej pory odpowiedzi</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <button class="btn btn-primary mt-2" type="button" onclick="addAnswer(0, ${question.id}, 0)">Dodaj odpowiedź</button>
                                <button class="btn btn-success mt-2" onclick="changeQuestionDetails(event)">Zapisz zmiany</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        // Append new question to accordion
        accordion.insertAdjacentHTML('beforeend', newQuestionHTML);

        var answers = questionData.answers;
        for (var i = 0; i < answers.length; i++) {
            createAnswerRow(answers[i], index, i);
        }


    }

    function removeRow(button) {
        // Find the row containing the button and remove it
        var row = button.closest('tr');
        row.parentNode.removeChild(row);
        checkAnswers();
    }

    function addAnswer(answer, questionIndex, answerIndex) {
        var tbody = document.getElementById('answersTable' + questionIndex);
        var noAnswersRow = document.getElementById('noAnswersRow' + questionIndex);

        // Sprawdź, czy tbody jest prawidłowy
        if (!tbody) {
            console.error('Nie można znaleźć tabeli odpowiedzi dla pytania o indeksie ' + questionIndex);
            return;
        }

        // Stwórz nowy wiersz odpowiedzi
        var newRow = createAnswerRow(answer, questionIndex, answerIndex);

        // Dodaj nowy wiersz do tabeli odpowiedzi
        tbody.appendChild(newRow);

        // Sprawdź, czy wyświetlić wiersz "Brak odpowiedzi"
        checkAnswers(tbody, noAnswersRow);
    }

    function createAnswerRow(answer, questionIndex, answerIndex) {
        var tbody = document.getElementById('answersTable' + questionIndex);

        // Tworzenie nowego wiersza odpowiedzi
        var newRow = document.createElement('tr');
        newRow.setAttribute('data-answer-index', answerIndex);

        // Komórka z odpowiedzią
        var answerCell = document.createElement('td');
        answerCell.textContent = answer.answer;
        answerCell.classList.add('text-center');
        newRow.appendChild(answerCell);

        // Komórka z checkboxem
        var correctnessCell = document.createElement('td');
        correctnessCell.classList.add('text-center');
        var checkbox = document.createElement('input');
        checkbox.setAttribute('type', 'checkbox');
        checkbox.classList.add('form-check-input');
        checkbox.checked = answer.isCorrect;
        correctnessCell.appendChild(checkbox);
        newRow.appendChild(correctnessCell);

        // Komórka z przyciskiem Usuń
        var deleteCell = document.createElement('td');
        deleteCell.classList.add('text-center');
        var deleteButton = document.createElement('button');
        deleteButton.setAttribute('type', 'button');
        deleteButton.classList.add('btn', 'btn-danger');
        deleteButton.textContent = 'Usuń';
        deleteButton.addEventListener('click', function() {
            removeRow(newRow);
        });
        deleteCell.appendChild(deleteButton);
        newRow.appendChild(deleteCell);

        // Dodanie nowego wiersza do tabeli odpowiedzi
        tbody.appendChild(newRow);

        // Sprawdzenie, czy wyświetlić wiersz "Brak odpowiedzi"
        checkAnswers(tbody, questionIndex);
    }

    function checkAnswers(tbody, questionIndex) {
        // Sprawdź, czy tbody jest prawidłowy
        if (!tbody) {
            console.error('Nie można znaleźć tabeli odpowiedzi dla pytania o indeksie ' + questionIndex);
            return;
        }

        var rows = tbody.querySelectorAll('tr');
        var noAnswersRow = document.getElementById('noAnswersRow' + questionIndex);

        // Sprawdzenie, czy wyświetlić wiersz "Brak odpowiedzi"
        if (rows.length === 1) {
            noAnswersRow.classList.remove('d-none');
        } else {
            noAnswersRow.classList.add('d-none');
        }
    }

    function changeTestDetails(event) {
        event.preventDefault();

        var form = document.getElementById('edit-test-form');
        var formData = new FormData(form);

        axios.patch(form.action, formData)
            .then(res => {
                document.querySelector("html").innerHTML = res.data;
            })
            .then(err => {
                console.error(err);
            })
    }

    function changeQuestionDetails(event) {
        event.preventDefault();

        var form = document.getElementById('edit-test-form');
        var formData = new FormData(form);

        axios.patch(form.action, formData)
            .then(res => {
                document.querySelector("html").innerHTML = res.data;
            })
            .then(err => {
                console.error(err);
            })
    }

</script>
</body>
</html>